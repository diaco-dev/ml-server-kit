
<!DOCTYPE html>
<html lang="fa" dir="rtl" class="h-full bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Server kit - پلتفرم استقرار خودکار مدل‌های هوش مصنوعی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <style>
    .status-uploaded { @apply bg-gray-600 text-gray-200; }
    .status-deploying { @apply bg-yellow-600 text-white animate-pulse; }
    .status-ready { @apply bg-emerald-600 text-white; }
    .status-failed { @apply bg-red-600 text-white; }
  </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-100">

  <!-- Header -->
  <header class="bg-black shadow-lg border-b border-emerald-500">
    <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center space-x-4 space-x-reverse">
        <div class="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center font-bold text-xl">N</div>
        <div>
          <h1 class="text-2xl font-bold text-emerald-400">Server-Kit</h1>
          <p class="text-sm text-gray-400">پلتفرم استقرار خودکار مدل‌های هوش مصنوعی</p>
        </div>
      </div>
      <div class="text-sm text-gray-400">
        <span class="text-emerald-400 font-semibold">MLOps Platform</span> v1.0
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-10">

    <!-- Upload Section -->
    <section class="bg-gray-800 rounded-xl shadow-xl p-8 mb-10 border border-gray-700">
      <h2 class="text-xl font-bold text-emerald-400 mb-6">آپلود مدل جدید</h2>
      <form
        hx-post="http://localhost:8000/api/v1/models"
        hx-target="#model-list"
        hx-swap="beforeend"
        hx-encoding="multipart/form-data"
        class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <input type="text" name="name" placeholder="نام مدل (مثال: fraud-detector)" required
               class="px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-emerald-500 text-white"/>

        <select name="framework" required class="px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
          <option value="">فریم‌ورک را انتخاب کنید</option>
          <option value="sklearn">Scikit-learn</option>
          <option value="pytorch">PyTorch</option>
          <option value="tensorflow">TensorFlow</option>
          <option value="onnx">ONNX</option>
        </select>

        <input type="file" name="file" accept=".pkl,.pt,.h5,.onnx" required
               class="px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-emerald-600 file:text-white hover:file:bg-emerald-700"/>

        <button type="submit"
                class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition">
          استقرار خودکار مدل
        </button>
      </form>
    </section>

    <!-- Model List -->
    <section class="bg-gray-800 rounded-xl shadow-xl p-8 border border-gray-700">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-emerald-400">مدل‌های مستقر شده</h2>
        <button hx-get="http://localhost:8000/api/v1/models"
                hx-target="#model-list"
                hx-trigger="click"
                class="text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition">
          ریفرش
        </button>
      </div>

      <div id="model-list"
           hx-get="http://localhost:8000/api/v1/models"
           hx-trigger="load, every 8s"
           class="space-y-4">
        <!-- مدل‌ها با HTMX به صورت خودکار لود می‌شوند -->
        <div class="text-center text-gray-500 py-10">در حال بارگذاری مدل‌ها...</div>
      </div>
    </section>
  </main>

  <!-- Template for each model -->
  <script type="text/html" id="model-template">
    <div class="bg-gray-750 border border-gray-700 rounded-lg p-6 hover:border-emerald-600 transition">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-bold text-white">{{name}} <span class="text-sm text-gray-400">v{{version}}</span></h3>
          <p class="text-sm text-gray-400">فریم‌ورک: {{framework}}</p>
        </div>
        <span class="px-4 py-2 rounded-full text-sm font-semibold status-{{status}}">
          {{status}}
        </span>
      </div>

      <div class="text-sm space-y-2">
        <p class="text-gray-400">آیدی: <code class="bg-gray-900 px-2 py-1 rounded">{{id}}</code></p>
        {{#if endpoint}}
          <div class="mt-4 p-4 bg-black rounded-lg border border-emerald-800">
            <p class="text-emerald-400 font-semibold mb-3">تست زنده پیش‌بینی</p>
            <div class="flex gap-3">
              <input type="number" step="0.01" value="1.0" placeholder="ورودی نمونه (x)"
                     class="w-32 px-3 py-2 bg-gray-800 rounded text-white" id="input-{{id}}"/>
              <button onclick="predict('{{endpoint}}', '{{id}}')"
                      class="bg-emerald-600 hover:bg-emerald-500 px-5 py-2 rounded font-medium transition">
                پیش‌بینی کن
              </button>
            </div>
            <p class="mt-3 text-sm" id="result-{{id}}"></p>
          </div>
          <p class="text-xs text-gray-500 mt-2">Endpoint: <code class="text-emerald-400">{{endpoint}}</code></p>
        {{else}}
          <p class="text-gray-500 italic">در حال استقرار...</p>
        {{/if}}
      </div>
    </div>
  </script>

  <script>
    // رندر خودکار مدل‌ها با Mustache-like syntax ساده
    htmx.on("htmx:afterSwap", (e) => {
      if (e.target.id === "model-list") {
        const template = document.getElementById("model-template").innerHTML;
        const models = JSON.parse(e.detail.xhr.response);
        e.target.innerHTML = models.map(model => {
          let html = template
            .replace(/{{id}}/g, model.id)
            .replace(/{{name}}/g, model.name)
            .replace(/{{version}}/g, model.version)
            .replace(/{{framework}}/g, model.framework)
            .replace(/{{status}}/g, statusFa(model.status))
            .replace(/{{endpoint}}/g, model.endpoint || '');
          return html;
        }).join("");
      }
    });

    function statusFa(status) {
      switch(status) {
        case 'uploaded': return 'آپلود شده';
        case 'deploying': return 'در حال استقرار';
        case 'ready': return 'آماده';
        case 'failed': return 'ناموفق';
        default: return status;
      }
    }

    async function predict(endpoint, id) {
      const input = document.getElementById(`input-${id}`).value;
      const resultEl = document.getElementById(`result-${id}`);
      resultEl.textContent = "در حال ارسال...";
      try {
        const res = await fetch(`${endpoint}?x=${input}`);
        const data = await res.json();
        resultEl.innerHTML = `<span class="text-emerald-400">نتیجه: ${data.prediction || JSON.stringify(data)}</span>`;
      } catch (err) {
        resultEl.innerHTML = `<span class="text-red-400">خطا در ارتباط با مدل</span>`;
      }
    }
  </script>
</body>
</html>